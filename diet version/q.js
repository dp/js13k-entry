(function(){window.Vectors={addVectorToPoint:function(a,b,d){var c;c={x:0,y:0};c.x=a.x+(Math.cos(b)*d);c.y=a.y+(Math.sin(b)*d);return c},angleDistBetweenPoints:function(a,b){var d,c,f,e;if(a===b){return 0}f=b.x-a.x;e=b.y-a.y;c=Math.sqrt(f*f+e*e);d=Math.acos(f/c);if(e<0){d=0-d}return{angle:d,distance:c}}};window.Light={init:function(a){this.lightEl=a;this.on=false;this.lightValue=100;this.viewRadius=0;this.alpha=1.0;this.reduction=4;this.tweening=false;this.tweenTimePassed=0;this.tweenTime=0;this.tweenTargetRadius=0;this.tweenTargetAlpha=0;this.tweenStartRadius=0;return this.tweenStartAlpha=0},update:function(a){var b;if(this.tweening){this.tweenTimePassed+=a;if(this.tweenTimePassed>this.tweenTime){b=1;this.tweening=false}else{b=this.tweenTimePassed/this.tweenTime}this.viewRadius=(this.tweenTargetRadius-this.tweenStartRadius)*b+this.tweenStartRadius;this.alpha=(this.tweenTargetAlpha-this.tweenStartAlpha)*b+this.tweenStartAlpha}else if(this.on){this.lightValue-=this.reduction*a;if(this.lightValue<1){this.lightValue=0;this.turnOff()}else{this.viewRadius=this.lightValue+20}}if(this.viewRadius>200){return this.viewRadius=200}},turnOff:function(a){if(a==null){a=3.0}this.on=false;this.viewRadius=0;this.alpha=0.0;this.tweenTo(a,100,0.4);this.lightEl.style.display='none';return true},turnOn:function(a){if(a==null){a=1.0}if(this.lightValue<1){return false}this.on=true;this.tweenTo(a,this.lightValue+20,1.0);this.lightEl.style.display='block';return true},tweenTo:function(a,b,d){this.tweenTimePassed=0;this.tweenTime=a;this.tweening=true;this.tweenStartRadius=this.viewRadius;this.tweenTargetRadius=b;this.tweenStartAlpha=this.alpha;return this.tweenTargetAlpha=d},addPower:function(){this.lightValue+=100;return this.turnOn(1.0)}};window.Map={init:function(){this.w=120;this.h=80;this.tileSize=25;this.seed=559516;this.settings={initialDensity:0.47,reseedDensity:0.51,smoothCorners:true,passes:["combine-aggressive","reseed-medium","combine-aggressive","reseed-small","combine-aggressive","remove-singles"],reseedMethod:'top',emptyTolerance:6,wallRoughness:0.2};this.canvas=document.createElement('canvas');this.canvas.width=(this.w+1)*this.tileSize;this.canvas.height=(this.h+1)*this.tileSize;this.canvas.style.width=this.canvas.width+'px';this.ctx=this.canvas.getContext('2d');this.floorCanvas=document.createElement('canvas');this.floorCanvas.width=(this.w+1)*this.tileSize;this.floorCanvas.height=(this.h+1)*this.tileSize;this.floorCtx=this.floorCanvas.getContext('2d');return this.generate()},generate:function(){var a,b,d,c,f,e,j;f=new Array(this.w);this.wTiles=new Array(this.w);for(e=a=0,d=this.w;0<=d?a<=d:a>=d;e=0<=d?++a:--a){f[e]=new Array(this.h);this.wTiles[e]=new Array(this.h);for(j=b=0,c=this.h;0<=c?b<=c:b>=c;j=0<=c?++b:--b){if(this.seededRandom()<this.settings.initialDensity||e===0||j===0||e===this.w||j===this.h){f[e][j]=true}}}return this.tiles=f},tileAtPos:function(a){return this.tiles[Math.floor(pox.x/this.tileSize)][Math.floor(pox.y/this.tileSize)]},generateCellular:function(){var c,f,e,j,i,g,h,k;e=this.tiles;j=[];for(h=c=0,f=e.length;c<f;h=++c){i=e[h];j.push((function(){var a,b,d;d=[];for(k=a=0,b=i.length;a<b;k=++a){g=i[k];if(g){d.push(this.tiles[h][k]={style:'W',sides:[]})}else{d.push(void 0)}}return d}).call(this))}return j},cellularPass:function(a){var b,d,c,f,e,j,i,g,h,k,l,m;for(l=d=1,i=this.w;1<=i?d<i:d>i;l=1<=i?++d:--d){for(m=c=1,g=this.h;1<=g?c<g:c>g;m=1<=g?++c:--c){this.wTiles[l][m]=this.tiles[l][m];if(a.match("combine")){if(this.nearbyTiles(l,m,1)>=5){if(a==='combine-aggressive'){this.tiles[l][m]=true}this.wTiles[l][m]=true}else{if(a==='combine-aggressive'){this.tiles[l][m]=null}this.wTiles[l][m]=null}}else if(a.match("reseed")){if(a==="reseed-huge"){j=7}else if(a==="reseed-large"){j=5}else if(a==="reseed-medium"){j=4}else{j=3}if(this.settings.reseedMethod==='top'){if(this.nearbyTiles(l+j,m+j,j)<=this.settings.emptyTolerance){if(this.seededRandom()<this.settings.reseedDensity){this.wTiles[l][m]=true}this.tiles[l][m]=this.wTiles[l][m]}}else{if(this.nearbyTiles(l,m,j)<=this.settings.emptyTolerance){if(this.seededRandom()<this.settings.reseedDensity){this.wTiles[l][m]=true}}}}else if(a==='remove-singles'){b=this.nearbyTiles(l,m,1);if(b===1&&this.tiles[l][m]){this.wTiles[l][m]=null}else if(b===8&&!this.tiles[l][m]){this.wTiles[l][m]=true}}}}for(l=f=1,h=this.w;1<=h?f<h:f>h;l=1<=h?++f:--f){for(m=e=1,k=this.h;1<=k?e<k:e>k;m=1<=k?++e:--e){this.tiles[l][m]=this.wTiles[l][m]}}return true},nearbyTiles:function(a,b,d){var c,f,e,j,i,g,h,k,l;c=0;for(k=f=j=a-d,i=a+d;j<=i?f<=i:f>=i;k=j<=i?++f:--f){for(l=e=g=b-d,h=b+d;g<=h?e<=h:e>=h;l=g<=h?++e:--e){if(k<0||k>=this.w||l<0||l>=this.h){c+=1}else{if(this.tiles[k][l]){c+=1}}}}return c},nearbyTile:function(a,b,d,c){return this.tiles[a+d][b+c]},findEdges:function(){var a,b,d,c,f,e,j,i,g;f=this.tiles;for(i=a=0,d=f.length;a<d;i=++a){e=f[i];for(g=b=0,c=e.length;b<c;g=++b){j=e[g];if(j){if(g>0){j.sides.above=this.tiles[i][g-1]}if(g<this.h){j.sides.below=this.tiles[i][g+1]}if(i>0){j.sides.left=this.tiles[i-1][g]}if(i<this.w){j.sides.right=this.tiles[i+1][g]}j.corners={tl:{x:(i+0)*this.tileSize,y:(g+0)*this.tileSize},tr:{x:(i+1)*this.tileSize,y:(g+0)*this.tileSize},bl:{x:(i+0)*this.tileSize,y:(g+1)*this.tileSize},br:{x:(i+1)*this.tileSize,y:(g+1)*this.tileSize}};j.surrounded=this.nearbyTiles(i,g,1)===9}}}return true},moveCorners:function(){var i,g,h,k,l,m,n,r,q,o,p;q=this.settings.wallRoughness*this.tileSize;r=[];for(o=i=0,n=this.w;0<=n?i<n:i>n;o=0<=n?++i:--i){r.push((function(){var a,b,d,c,f,e,j;j=[];for(p=a=0,b=this.h;0<=b?a<b:a>b;p=0<=b?++a:--a){l=m=0;if(this.settings.smoothCorners){g=0;if(this.tiles[o][p]){g+=1}if(this.tiles[o+1][p]){g+=2}if(this.tiles[o][p+1]){g+=4}if(this.tiles[o+1][p+1]){g+=8}if(g===1||g===4||g===11||g===14){l=-1}else if(g===2||g===7||g===8||g===13){l=1}if(g===1||g===2||g===14||g===14){m=-1}else if(g===4||g===7||g===8||g===11){m=1}l=l*this.tileSize/4;m=m*this.tileSize/4}h=((o+1)*this.tileSize)+l+this.randInt(-q/2,q);k=((p+1)*this.tileSize)+m+this.randInt(-q/2,q);if((d=this.tiles[o][p])!=null){d.corners.br={x:h,y:k}}if((c=this.tiles[o+1][p])!=null){c.corners.bl={x:h,y:k}}if((f=this.tiles[o][p+1])!=null){f.corners.tr={x:h,y:k}}j.push((e=this.tiles[o+1][p+1])!=null?e.corners.tl={x:h,y:k}:void 0)}return j}).call(this))}return r},findSides:function(){var c,f,e,j,i,g,h,k,l;j=this.tiles;i=[];for(k=c=0,f=j.length;c<f;k=++c){g=j[k];i.push((function(){var a,b,d;d=[];for(l=a=0,b=g.length;a<b;l=++a){h=g[l];if(h){h.lines=[];if(!h.sides.above){e={x1:h.corners.tl.x,y1:h.corners.tl.y,x2:h.corners.tr.x,y2:h.corners.tr.y};e.stuff=this.findNormals(e.x1,e.y1,e.x2,e.y2);h.lines.push(e)}if(!h.sides.left){e={x1:h.corners.tl.x,y1:h.corners.tl.y,x2:h.corners.bl.x,y2:h.corners.bl.y};e.stuff=this.findNormals(e.x2,e.y2,e.x1,e.y1);h.lines.push(e)}if(!h.sides.right){e={x1:h.corners.tr.x,y1:h.corners.tr.y,x2:h.corners.br.x,y2:h.corners.br.y};e.stuff=this.findNormals(e.x1,e.y1,e.x2,e.y2);h.lines.push(e)}if(!h.sides.below){e={x1:h.corners.bl.x,y1:h.corners.bl.y,x2:h.corners.br.x,y2:h.corners.br.y};e.stuff=this.findNormals(e.x2,e.y2,e.x1,e.y1);d.push(h.lines.push(e))}else{d.push(void 0)}}else{d.push(void 0)}}return d}).call(this))}return i},findNormals:function(a,b,d,c){var f,e;e=1;f=Vectors.angleDistBetweenPoints({x:a,y:b},{x:d,y:c});return{mp:e,ang:f.angle,normal:f.angle-Math.PI/2}},print:function(){var a,b,d,c,f;d=this.tiles;c=[];for(a=0,b=d.length;a<b;a++){f=d[a];c.push(console.log(f.join()))}return c},draw:function(){var a,b,d,c;c=this.settings.passes;for(a=0,b=c.length;a<b;a++){d=c[a];this.cellularPass(d)}this.generateCellular();this.findEdges();this.moveCorners();this.findSides();this.drawFloor();this.drawWalls(this.ctx);return this.imageData=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)},pixelAt:function(a,b){var d,c,f,e,j;a=Math.floor(a);b=Math.floor(b);e=((this.canvas.width*b)+a)*4;j=this.imageData.data[e];f=this.imageData.data[e+1];c=this.imageData.data[e+2];d=this.imageData.data[e+3];return[j,f,c,d]},drawWalls:function(c){var f,e,j,i,g,h,k,l;console.log(c);c.fillStyle='#585655';c.strokeStyle='#585655';j=this.tiles;i=[];for(k=f=0,e=j.length;f<e;k=++f){g=j[k];i.push((function(){var a,b,d;d=[];for(l=a=0,b=g.length;a<b;l=++a){h=g[l];if(h){c.beginPath();c.moveTo(h.corners.tl.x,h.corners.tl.y);c.lineTo(h.corners.tr.x,h.corners.tr.y);c.lineTo(h.corners.br.x,h.corners.br.y);c.lineTo(h.corners.bl.x,h.corners.bl.y);c.fill();d.push(c.stroke())}else{d.push(void 0)}}return d})())}return i},drawEdges:function(a){var b,d,c,f,e,j,i,g,h,k,l,m,n;a.strokeStyle='sandstone';a.beginPath();g=this.tiles;for(m=b=0,c=g.length;b<c;m=++b){k=g[m];for(n=d=0,f=k.length;d<f;n=++d){l=k[n];if(l){h=l.lines;for(i=0,e=h.length;i<e;i++){j=h[i];a.moveTo(j.x1,j.y1);a.lineTo(j.x2,j.y2)}}}}return a.stroke()},drawFloor:function(){var j,i,g,h,k,l,m,n,r,q,o,p,v,w,u,y,A,x,z,B,C,D,s,t;this.floorCtx.fillStyle='#888';this.floorCtx.fillRect(0,0,this.canvas.width,this.canvas.height);h=this.randInt(0,360);k=h+180;x=5;z=10;B=3;C=1;D=4;for(s=m=0,p=this.w;0<=p?m<=p:m>=p;s=0<=p?++m:--m){for(t=n=0,v=this.h;0<=v?n<=v:n>=v;t=0<=v?++n:--n){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,5))+"%,"+(this.randInt(60,20))+"%,0.5)";this.drawRandomisedRect(s*this.tileSize+this.randInt(0,x),t*this.tileSize+this.randInt(0,x),this.tileSize+this.randInt(0,z),this.tileSize+this.randInt(0,z),i,B)}}for(s=r=0,w=this.w;0<=w?r<=w:r>=w;s=0<=w?++r:--r){for(t=q=0,u=this.h;0<=u?q<=u:q>=u;t=0<=u?++q:--q){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,5))+"%,"+(this.randInt(60,20))+"%,0.8)";this.drawRandomisedRect(s*this.tileSize+this.randInt(0,x),t*this.tileSize+this.randInt(0,x),this.tileSize+this.randInt(0,z),this.tileSize+this.randInt(0,z),i,B)}}A=[];for(s=o=0,y=this.w;0<=y?o<=y:o>=y;s=0<=y?++o:--o){A.push((function(){var c,f,e;e=[];for(t=c=0,f=this.h;0<=f?c<=f:c>=f;t=0<=f?++c:--c){if(!(this.tiles[s][t]&&this.tiles[s][t].surrounded)){g=this.nearbyTiles(s,t,2);j=((1-(g/20))*80)/2+20;e.push((function(){var a,b,d;b=[];for(l=d=0,a=this.randInt(0,g*2);0<=a?d<=a:d>=a;l=0<=a?++d:--d){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,x))+"%,"+(this.randInt(j,20))+"%,0.8)";b.push(this.drawCircle(s*this.tileSize+this.randInt(0,this.tileSize),t*this.tileSize+this.randInt(0,this.tileSize),this.randInt(C,D),i))}return b}).call(this))}else{e.push(void 0)}}return e}).call(this))}return A},drawRandomisedRect:function(a,b,d,c,f,e){this.floorCtx.fillStyle=f;this.floorCtx.beginPath();this.floorCtx.moveTo(a+this.randInt(0,e),b+this.randInt(0,e));this.floorCtx.lineTo(a+d+this.randInt(0,e),b+this.randInt(0,e));this.floorCtx.lineTo(a+d+this.randInt(0,e),b+c+this.randInt(0,e));this.floorCtx.lineTo(a+this.randInt(0,e),b+c+this.randInt(0,e));return this.floorCtx.fill()},randHue:function(a,b){var d;if(Math.random()>0.5){d=a}else{d=b}return d+this.randInt(-10,20)},drawCircle:function(a,b,d,c){this.floorCtx.fillStyle=c;this.floorCtx.beginPath();this.floorCtx.arc(a,b,d,0,Math.PI*2);return this.floorCtx.fill()},lines:function(){var a,b,d,c,f,e,j,i,g,h,k,l;j=[];g=this.tiles;for(a=0,d=g.length;a<d;a++){k=g[a];for(b=0,c=k.length;b<c;b++){l=k[b];if(l){h=l.lines;for(i=0,f=h.length;i<f;i++){e=h[i];j.push([{x:e.x1,y:e.y1},{x:e.x2,y:e.y2},e.stuff])}}}}return j},seededRandom:function(){var a;a=Math.sin(this.seed++)*10000;return a-Math.floor(a)},randInt:function(a,b){return Math.floor(this.seededRandom()*b)+a}};window.Game={init:function(){Map.init();Map.draw();this.tileSize=Map.tileSize;this.state=0;this.playerEl=byId('p');this.lightEl=byId('l');this.playerEl.style.left=((window.innerWidth-60)/2)+"px";this.playerEl.style.top=((window.innerHeight-48)/2)+"px";this.lightEl.style.left=((window.innerWidth-60)/2)+"px";this.lightEl.style.top=((window.innerHeight-48)/2)+"px";Light.init(this.lightEl);this.initGameParams({monsters:[[32,49],[80,18],[102,19],[62,21],[76,38],[57,24],[113,72],[116,75],[117,72],[115,63],[73,67],[49,72],[5,70],[13,35],[49,75],[97,70],[86,12],[63,59],[91,22]],orbs:[[60,61],[35,33],[10,62],[18,48],[105,77],[114,50],[116,16],[49,29],[73,38],[80,5],[79,72],[101,58],[72,45],[80,49],[51,46]],triggers:[{x:70,y:43,r:3,msg:"Let's get out of here"},{x:85,y:59,r:7,msg:"I think we're headed in the right direction"},{x:117,y:69,r:5,msg:"I've got a bad feeling about this ..."},{x:52,y:21,r:7,msg:"I'm sure the air is fresher here"},{x:57,y:60,r:5,msg:"Do we need that light?"}]});this.maskCanvas=byId('lm');this.maskCtx=this.maskCanvas.getContext('2d');this.maskCanvas.width=Math.floor(window.innerWidth/2);this.maskCanvas.height=Math.floor(window.innerHeight/2);this.maskCanvas.style.width=window.innerWidth+'px';this.maskCanvas.style.height=window.innerHeight+'px';this.maskCtx.fillStyle='#000';this.maskCtx.fillRect(0,0,this.maskCanvas.width,this.maskCanvas.height);this.shadowCanvas=document.createElement('canvas');this.shadowCtx=this.shadowCanvas.getContext('2d');this.shadowCanvas.width=this.maskCanvas.width;this.shadowCanvas.height=this.maskCanvas.height;this.viewCanvas=byId('v');this.viewCtx=this.viewCanvas.getContext('2d');this.viewCanvas.width=this.maskCanvas.width;this.viewCanvas.height=this.maskCanvas.height;this.viewCanvas.style.width=this.maskCanvas.style.width;this.viewCanvas.style.height=this.maskCanvas.style.height;this.viewCtx.translate(0.5,0.5);this.itemsCanvas=document.createElement('canvas');this.itemsCtx=this.itemsCanvas.getContext('2d');this.itemsCanvas.width=this.maskCanvas.width;this.itemsCanvas.height=this.maskCanvas.height;this.positionMap();this.pos=this.tilePosToGameXY([76,49]);this.exit=this.tilePosToGameXY([37,21]);this.lines=[];this.speed=125;this.monsterSpeed=110;this.initLines();Light.turnOff(3);this.openingText();return requestAnimationFrame(update)},update:function(a){var b,d,c,f,e;if(this.lastTimestamp){d=(a-this.lastTimestamp)/1000}else{d=0}this.lastTimestamp=a;if(this.state===1){f=byId('pg');f.style.top=parseInt(f.style.top)-1+'px'}else if(this.state===2){if(Light.tweening){Light.update(d)}}else{Light.update(d);if(right||left||up||down){c=this.speed*d;e=12+c;if(right){if(!this.wallAt({x:this.pos.x+e,y:this.pos.y})){this.pos.x+=c}b='r'}if(left){if(!this.wallAt({x:this.pos.x-e,y:this.pos.y})){this.pos.x-=c}b='l'}if(down){if(!this.wallAt({x:this.pos.x,y:this.pos.y+e})){this.pos.y+=c}b='d'}if(up){if(!this.wallAt({x:this.pos.x,y:this.pos.y-e})){this.pos.y-=c}b='u'}this.lightEl.className=this.playerEl.className=b;if(this.itemInRange({x:this.exit.x,y:this.exit.y-70},80)){this.win()}}if(window.toggleLight){if(Light.on){Light.turnOff()}else{Light.turnOn()}window.toggleLight=false}this.playerTouchingOrb();this.playerTouchingTrigger();this.moveMonsters(d)}return this.draw(d)},moveMonsters:function(b){var d,c,f,e,j,i,g,h,k,l,m,n,r,q,o,p,v,w,u;r=this.monsters;q=[];for(g=h=0,l=r.length;h<l;g=++h){m=r[g];if(this.itemOnScreen(m)||m.state===1){j=(this.pos.x-m.x)/20;i=(this.pos.y-m.y)/20;u=true;for(g=k=0;k<=20;g=++k){if(this.wallAt({x:m.x+j*g,y:m.y+i*g})){u=false}}if(u&&m.state===0){q.push(m.state=1)}else if(m.state===1){d=Vectors.angleDistBetweenPoints(m,this.pos);e=d.distance;c=d.angle;if(u&&Light.on&&e>40&&(e<Light.viewRadius)){o=this.monsterSpeed*(e/Light.lightValue)/3;c+=0.5}else{o=this.monsterSpeed}p=true;f=0;q.push((function(){var a;a=[];while(p&&f<20){n=Vectors.addVectorToPoint(m,c,o*b);v=Vectors.addVectorToPoint(n,c+1.0,18.0);w=Vectors.addVectorToPoint(n,c-1.0,18.0);f+=1;if(this.wallAt(v)){c-=0.3;a.push(o=o+15)}else if(this.wallAt(w)){c+=0.4;a.push(o=o+10)}else{m.x=n.x;m.y=n.y;p=false;if(this.state===0){if(Vectors.distBetweenPoints(this.pos,m)<22){a.push(this.die())}else{a.push(void 0)}}else{a.push(void 0)}}}return a}).call(this))}else{q.push(void 0)}}else{q.push(void 0)}}return q},die:function(){var a;byId('vp').className='ded';a=byId('pg');a.style.top=this.playerEl.style.top;a.style.left=this.playerEl.style.left;this.state=1;return this.say('You had one job ... ',4,10)},win:function(){byId('vp').className='win';this.state=2;this.playerEl.className='d';this.lightEl.className='d';Light.addPower();return this.say("Thanks, you're a hero!<br>I think Ill be ok from here :)",100,200)},draw:function(){this.shadowCtx.clearRect(0,0,this.shadowCanvas.width,this.shadowCanvas.height);this.shadowCtx.save();this.shadowCtx.translate(this.viewX-this.pos.x,this.viewY-this.pos.y);this.itemsCtx.clearRect(0,0,this.itemsCanvas.width,this.itemsCanvas.height);this.itemsCtx.save();this.itemsCtx.translate(this.viewX-this.pos.x,this.viewY-this.pos.y);this.maskCtx.fillStyle='#000';this.maskCtx.fillRect(0,0,this.maskCanvas.width,this.maskCanvas.height);this.drawOrbs();this.drawMonsters();this.drawLineShadows();this.drawPlayerShadow();this.drawExit(this.itemsCtx);this.itemsCtx.restore();this.shadowCtx.restore();return this.compositeCanvas()},wallAt:function(a){return Map.pixelAt(a.x,a.y)[3]>10},compositeCanvas:function(){this.viewCtx.fillStyle='red';this.viewCtx.fillRect(0,0,this.viewCanvas.width,this.viewCanvas.height);this.viewCtx.drawImage(Map.floorCanvas,this.viewX-this.pos.x,this.viewY-this.pos.y);this.itemsCtx.globalCompositeOperation='destination-out';this.itemsCtx.drawImage(this.shadowCanvas,0,0);this.itemsCtx.globalCompositeOperation='source-over';this.maskCtx.drawImage(this.shadowCanvas,0,0);this.viewCtx.drawImage(this.itemsCanvas,0,0);if(Light.on){this.viewCtx.globalAlpha=0.6;this.viewCtx.drawImage(this.shadowCanvas,0,0);this.viewCtx.globalAlpha=1}this.viewCtx.drawImage(Map.canvas,this.viewX-this.pos.x,this.viewY-this.pos.y);return this.drawLightMask()},drawPlayerShadow:function(){var a,b;b=24/2;this.shadowCtx.save();this.shadowCtx.translate(this.pos.x,this.pos.y+24/2);this.shadowCtx.scale(1,0.25);a=this.shadowCtx.createRadialGradient(0,0,0,0,0,b);a.addColorStop(0,'rgba(0,0,0,0.6)');a.addColorStop(1,'rgba(0,0,0,0)');this.shadowCtx.fillStyle=a;this.shadowCtx.beginPath();this.shadowCtx.arc(0,0,b,0,Math.PI*2);this.shadowCtx.fill();return this.shadowCtx.restore()},playerTouchingOrb:function(){var a,b,d,c,f,e;f=this.orbs;e=[];for(a=b=0,d=f.length;b<d;a=++b){c=f[a];if(this.itemInRange(c,this.tileSize)&&!c.used){Light.addPower();e.push(c.used=true)}else{e.push(void 0)}}return e},playerTouchingTrigger:function(){var a,b,d,c,f;d=this.triggers;c=[];for(a=0,b=d.length;a<b;a++){f=d[a];if(this.itemInRange(f,f.r)&&!f.used){console.log('t',f.msg);if(f.action){eval(f.action)}if(f.msg){this.say(f.msg,0,0)}c.push(f.used=true)}else{c.push(void 0)}}return c},drawOrbs:function(){var a,b,d,c,f,e,j,i,g,h,k;a=this.itemsCtx;d=15;h=4;b=a.createRadialGradient(0,0,h,0,0,d);b.addColorStop(0,'rgba(143,194,242,0.4)');b.addColorStop(1,'rgba(191,226,226,0)');g=a.createRadialGradient(1,-1,1,0,0,h);g.addColorStop(0,'#bfe2e2');g.addColorStop(1,'#8fc2f2');this.maskCtx.fillStyle="#000";j=d*1.5;c=this.maskCtx.createRadialGradient(0,0,0,0,0,j);c.addColorStop(0,"rgba(255,255,255,0.8)");c.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=c;k=this.orbs;for(f=0,e=k.length;f<e;f++){i=k[f];if(this.itemOnScreen(i)&&!i.used){a.save();a.translate(i.x,i.y);a.fillStyle=b;a.beginPath();a.arc(0,0,d,0,Math.PI*2);a.fill();a.fillStyle=g;a.beginPath();a.arc(0,0,h,0,Math.PI*2);a.fill();a.restore();this.maskCtx.save();this.maskCtx.translate(i.x-this.pos.x+this.viewX,i.y-this.pos.y+this.viewY);this.maskCtx.beginPath();this.maskCtx.arc(0,0,j,0,Math.PI*2);this.maskCtx.fill();this.maskCtx.restore()}}return this.maskCtx.globalCompositeOperation='source-over'},drawMonsters:function(){var a,b,d,c,f,e,j,i,g;b=this.itemsCtx;d=this.maskCtx;j=12;i=this.monsters;g=[];for(c=0,f=i.length;c<f;c++){e=i[c];if(this.itemOnScreen(e)){a=Vectors.angleDistBetweenPoints(this.pos,e);b.save();b.translate(e.x,e.y);b.rotate(a.angle);b.fillStyle='#000';b.beginPath();b.arc(0,0,j,0,Math.PI*2);b.fill();b.fillStyle='#a10';b.scale(0.5,1.0);b.beginPath();b.arc(-13,4,3,0,Math.PI*2);b.arc(-13,-4,3,0,Math.PI*2);b.fill();b.restore();d.save();d.translate(e.x-this.pos.x+this.viewX,e.y-this.pos.y+this.viewY);d.rotate(a.angle);d.fillStyle='#f20';d.scale(0.5,1.0);d.beginPath();d.arc(-13,4,3,0,Math.PI*2);d.arc(-13,-4,3,0,Math.PI*2);d.fill();g.push(d.restore())}else{g.push(void 0)}}return g},itemInRange:function(a,b){return(Math.abs(a.x-this.pos.x)<b)&&(Math.abs(a.y-this.pos.y)<b)},itemOnScreen:function(a){return(Math.abs(a.x-this.pos.x)<this.viewX)&&(Math.abs(a.y-this.pos.y)<this.viewY)},drawLines:function(){var a,b,d,c;this.shadowCtx.strokeStyle='#800';this.shadowCtx.beginPath();c=this.lines;for(a=0,d=c.length;a<d;a++){b=c[a];this.shadowCtx.moveTo(b[0].x,b[0].y);this.shadowCtx.lineTo(b[1].x,b[1].y)}return this.shadowCtx.stroke()},drawLineShadows:function(){var a,b,d,c,f,e,j,i,g,h,k;this.shadowCtx.fillStyle='#000';this.shadowCtx.strokeStyle='#000';h=this.lines;k=[];for(f=0,j=h.length;f<j;f++){e=h[f];i=e[0];if(this.itemOnScreen(i)){g=e[1];a=Vectors.angleDistBetweenPoints(this.pos,i);b=Vectors.angleDistBetweenPoints(this.pos,g);if(e[2]){d=a.angle;c=d-e[2].ang;if(c<Math.PI){c+=Math.PI*2}if(c>Math.PI){c-=Math.PI*2}if(c<0){k.push(this.drawShadow(i,g,a.angle,b.angle))}else{k.push(void 0)}}else{k.push(void 0)}}else{k.push(void 0)}}return k},drawShadow:function(a,b,d,c){var f,e;this.shadowCtx.beginPath();f=Vectors.addVectorToPoint(a,d,900);e=Vectors.addVectorToPoint(b,c,900);this.shadowCtx.moveTo(a.x,a.y);this.shadowCtx.lineTo(f.x,f.y);this.shadowCtx.lineTo(e.x,e.y);this.shadowCtx.lineTo(b.x,b.y);this.shadowCtx.lineTo(a.x,a.y);this.shadowCtx.fill();this.shadowCtx.beginPath();this.shadowCtx.moveTo(a.x,a.y);this.shadowCtx.lineTo(f.x,f.y);return this.shadowCtx.stroke()},drawLightMask:function(){var a,b;this.maskCtx.fillStyle="#000";b=Light.viewRadius;a=this.maskCtx.createRadialGradient(this.viewX,this.viewY,b/4,this.viewX,this.viewY,b);a.addColorStop(0,"rgba(255,255,255,"+Light.alpha+")");a.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=a;this.maskCtx.beginPath();this.maskCtx.arc(this.viewX,this.viewY,b,0,Math.PI*2);this.maskCtx.fill();return this.maskCtx.globalCompositeOperation='source-over'},drawExit:function(a){var b,d,c,f,e,j,i,g,h,k;if(this.itemOnScreen(this.exit)){i=this.tileSize;if(!this.lightRays){this.lightRays=[];for(d=c=0;c<=5;d=++c){k=randInt(-i,i*2);this.lightRays.push({x:k,y:randInt(-7,14),w:randInt(2,i-k),h:randInt(100,50)})}console.log(this.lightRays)}a.save();a.translate(this.exit.x,this.exit.y);a.scale(1,0.4);b=a.createRadialGradient(0,0,0,0,0,i);b.addColorStop(0,'rgba(255, 255, 255, 0.9)');b.addColorStop(1,'rgba(255, 255, 255, 0.2)');a.fillStyle=b;a.beginPath();a.arc(0,0,i,0,Math.PI*2);a.fill();a.restore();a.save();a.translate(this.exit.x,this.exit.y);h=this.lightRays;for(f=0,e=h.length;f<e;f++){g=h[f];b=a.createLinearGradient(g.x,g.y,g.x,g.y-g.h);b.addColorStop(0,"rgba(255, 255, 255, "+(0.3+Math.random()/5)+")");b.addColorStop(1,'rgba(255, 255, 255, 0)');a.fillStyle=b;a.beginPath();a.moveTo(g.x,g.y);a.lineTo(g.x-0.2*g.h,g.y-g.h);a.lineTo(g.x-0.2*g.h+g.w,g.y-g.h);a.lineTo(g.x+g.w,g.y);a.fill()}a.restore();this.maskCtx.fillStyle="#000";j=i*1.5;b=this.maskCtx.createRadialGradient(0,0,0,0,0,j);b.addColorStop(0,"rgba(255,255,255,0.8)");b.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=b;this.maskCtx.save();this.maskCtx.translate(this.exit.x-this.pos.x+this.viewX,this.exit.y-this.pos.y+this.viewY);this.maskCtx.scale(1,0.4);this.maskCtx.beginPath();this.maskCtx.arc(0,0,j,0,Math.PI*2);this.maskCtx.fill();this.maskCtx.restore();return this.maskCtx.globalCompositeOperation='source-over'}},initLines:function(){return this.lines=Map.lines()},positionMap:function(){this.viewX=window.innerWidth/4;return this.viewY=window.innerHeight/4},initGameParams:function(a){var b,d,c,f,e,j,i,g,h,k,l,m,n;this.monsters=[];this.orbs=[];this.triggers=[];h=a.monsters;for(b=0,c=h.length;b<c;b++){g=h[b];i=this.tilePosToGameXY(g);i.state=0;this.monsters.push(i)}k=a.orbs;for(d=0,f=k.length;d<f;d++){g=k[d];this.orbs.push(this.tilePosToGameXY(g))}l=a.triggers;m=[];for(j=0,e=l.length;j<e;j++){n=l[j];n.x*=this.tileSize;n.y*=this.tileSize;n.r=n.r*this.tileSize/2;m.push(this.triggers.push(n))}return m},tilePosToGameXY:function(a){return{x:(a[0]+.5)*this.tileSize,y:(a[1]+.5)*this.tileSize}},testTrigger:function(a){this.testCount||(this.testCount=1);console.log('trigger',this.testCount);return a.used=true},say:function(a,b,d){var c,f;a=a.replace(/\s/g,'&nbsp;').replace("'",'&rsquo;');b=2000+b*1000;c=document.createElement('span');c.innerHTML=a;c.className='t fi';f=document.getElementById('o');f.appendChild(c);setTimeout((function(){return c.className='t'}),100);setTimeout((function(){return c.className='t fo'}),b);return setTimeout((function(){return f.removeChild(c)}),b+4000+d)},saySoon:function(b,d,c){return setTimeout(((function(a){return function(){return a.say(b,d,0)}})(this)),c*1000)},openingText:function(){var a,b,d,c,f;d=[['. . .',0,0],["How did I end up here?",0,3]];f=[];for(a=0,b=d.length;a<b;a++){c=d[a];f.push(this.saySoon(c[0],c[1],c[2]))}return f}};window.randSeed=1234;window.randomX=function(){var a;a=Math.sin(randSeed++)*10000;return a-Math.floor(a)};window.randInt=function(a,b){return Math.floor(randomX()*b)+a};window.update=function(a){Game.update(a);if(window.paused){console.log('Game is paused')}else{window.requestAnimationFrame(update)}return true};window.byId=function(a){return document.getElementById(a)};window.up=window.right=window.down=window.left=false;window.onkeydown=function(a){if(a.keyCode===32){window.toggleLight=true}if(a.keyCode===38||a.keyCode===90||a.keyCode===87){window.up=true}if(a.keyCode===39||a.keyCode===68){window.right=true}if(a.keyCode===40||a.keyCode===83){window.down=true}if(a.keyCode===37||a.keyCode===65||a.keyCode===81){window.left=true}if(a.keyCode===66){window.paused=true;return console.log('Paused')}};window.onkeyup=function(a){if(a.keyCode===38||a.keyCode===90||a.keyCode===87){window.up=false}if(a.keyCode===39||a.keyCode===68){window.right=false}if(a.keyCode===40||a.keyCode===83){window.down=false}if(a.keyCode===37||a.keyCode===65||a.keyCode===81){return window.left=false}};window.initGame=function(){return Game.init()}}).call(this);
