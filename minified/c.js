(function(){window.V={m1:function(a,b,c){var d;d={x:0,y:0};d.x=a.x+(Math.cos(b)*c);d.y=a.y+(Math.sin(b)*c);return d},m2:function(a,b){var c,d,f,e;if(a===b){return 0}f=b.x-a.x;e=b.y-a.y;d=Math.sqrt(f*f+e*e);c=Math.acos(f/d);if(e<0){c=0-c}return{angle:c,distance:d}},m3:function(a,b){var c,d;if(a===b){return 0}c=b.x-a.x;d=b.y-a.y;return Math.sqrt(c*c+d*d)}};window.L={init:function(a){this.lightEl=a;this.on=false;this.lightValue=0;this.viewRadius=0;this.alpha=1.0;this.reduction=7;this.tweening=false;this.tweenTimePassed=0;this.tweenTime=0;this.tweenTargetRadius=0;this.tweenTargetAlpha=0;this.tweenStartRadius=0;this.tweenStartAlpha=0;this.tweenRadius=0;return this.maxDarkRadius=40},update:function(a){var b;if(this.tweening){this.tweenTimePassed+=a;if(this.tweenTimePassed>this.tweenTime){b=1;this.tweening=false}else{b=this.tweenTimePassed/this.tweenTime}this.viewRadius=(this.tweenTargetRadius-this.tweenStartRadius)*b+this.tweenStartRadius;this.alpha=(this.tweenTargetAlpha-this.tweenStartAlpha)*b+this.tweenStartAlpha}else if(this.on){this.lightValue-=this.reduction*a;if(this.lightValue<1){this.lightValue=0;this.turnOff()}else{this.viewRadius=this.lightValue}}else{this.viewRadius=this.maxDarkRadius}return this.viewRadius=Math.pow(this.viewRadius,0.333)*40},turnOff:function(a){if(a==null){a=2.0}this.on=false;this.viewRadius=0;this.alpha=0.0;this.tweenTo(a,this.maxDarkRadius,0.4);this.lightEl.style.display='none';return true},turnOn:function(a){if(a==null){a=1.0}if(this.lightValue<1){return false}this.on=true;this.tweenTo(a,this.lightValue,1.0);this.lightEl.style.display='block';return true},tweenTo:function(a,b,c){this.tweenTimePassed=0;this.tweenTime=a;this.tweening=true;this.tweenStartRadius=Math.pow(this.viewRadius/40,1/0.333);this.tweenTargetRadius=b;this.tweenStartAlpha=this.alpha;return this.tweenTargetAlpha=c},addPower:function(){this.lightValue+=90;return this.turnOn(1.0)}};window.Msg={init:function(a,b,c){this.ctx=a;this.originX=b;this.originY=c;this.messages=[];this.list=[];return this.maxTime=10},update:function(a){var b,c,d,f,e;f=this.messages;e=[];for(b=0,c=f.length;b<c;b++){d=f[b];if(d.hold>0){e.push(d.hold-=a)}else if(d.fade>0){e.push(d.fade-=a)}else{e.push(void 0)}}return e},draw:function(){var a,b,c,d,f;d=this.messages;f=[];for(a=0,b=d.length;a<b;a++){c=d[a];if(c.fade>0){if(c.hold<=0){this.ctx.globalAlpha=c.fade/c.fadeTime}this.ctx.fillStyle=c.colour;this.ctx.font=c.font;this.ctx.fillText(c.txt,c.x,c.y);f.push(this.ctx.globalAlpha=1.0)}else{f.push(void 0)}}return f},say:function(a,b){var c,d,f,e,j,i,g,h,k,l,m,n;if(b==null){b={}}h=a.split('|');b.colour||(b.colour='white');b.x||(b.x=this.originX-235);b.y||(b.y=0);b.size||(b.size=18);b.hold||(b.hold=2);b.fade||(b.fade=10);n=[];for(d=f=0,j=h.length;f<j;d=++f){g=h[d];l={txt:g,colour:b.colour,size:b.size,font:b.size+"px sans-serif",x:this.originX+b.x,y:this.originY+b.y,hold:b.hold,fade:b.fade,fadeTime:b.fade};this.messages.push(l);if(!b.y){c=l.size+5;if(d===0){c+=20}m=this.list;for(e=0,i=m.length;e<i;e++){k=m[e];k.y-=c}n.push(this.list.push(l))}else{n.push(void 0)}}return n}};window.Map={init:function(){this.w=120;this.h=80;this.tileSize=25;this.seed=559516;this.settings={initialDensity:0.47,reseedDensity:0.51,smoothCorners:true,passes:["combine-aggressive","reseed-medium","combine-aggressive","reseed-small","combine-aggressive","remove-singles"],reseedMethod:'top',emptyTolerance:6,wallRoughness:0.2};this.canvas=document.createElement('canvas');this.canvas.width=(this.w+1)*this.tileSize;this.canvas.height=(this.h+1)*this.tileSize;this.canvas.style.width=this.canvas.width+'px';this.ctx=this.canvas.getContext('2d');this.floorCanvas=document.createElement('canvas');this.floorCanvas.width=(this.w+1)*this.tileSize;this.floorCanvas.height=(this.h+1)*this.tileSize;this.floorCtx=this.floorCanvas.getContext('2d');return this.generate()},generate:function(){var a,b,c,d,f,e,j;f=new Array(this.w);this.wTiles=new Array(this.w);for(e=a=0,c=this.w;0<=c?a<=c:a>=c;e=0<=c?++a:--a){f[e]=new Array(this.h);this.wTiles[e]=new Array(this.h);for(j=b=0,d=this.h;0<=d?b<=d:b>=d;j=0<=d?++b:--b){if(this.seededRandom()<this.settings.initialDensity||e===0||j===0||e===this.w||j===this.h){f[e][j]=true}}}return this.tiles=f},tileAtPos:function(a){return this.tiles[Math.floor(pox.x/this.tileSize)][Math.floor(pox.y/this.tileSize)]},generateCellular:function(){var d,f,e,j,i,g,h,k;e=this.tiles;j=[];for(h=d=0,f=e.length;d<f;h=++d){i=e[h];j.push((function(){var a,b,c;c=[];for(k=a=0,b=i.length;a<b;k=++a){g=i[k];if(g){c.push(this.tiles[h][k]={style:'W',sides:[]})}else{c.push(void 0)}}return c}).call(this))}return j},cellularPass:function(a){var b,c,d,f,e,j,i,g,h,k,l,m;for(l=c=1,i=this.w;1<=i?c<i:c>i;l=1<=i?++c:--c){for(m=d=1,g=this.h;1<=g?d<g:d>g;m=1<=g?++d:--d){this.wTiles[l][m]=this.tiles[l][m];if(a.match("combine")){if(this.nearbyTiles(l,m,1)>=5){if(a==='combine-aggressive'){this.tiles[l][m]=true}this.wTiles[l][m]=true}else{if(a==='combine-aggressive'){this.tiles[l][m]=null}this.wTiles[l][m]=null}}else if(a.match("reseed")){if(a==="reseed-huge"){j=7}else if(a==="reseed-large"){j=5}else if(a==="reseed-medium"){j=4}else{j=3}if(this.settings.reseedMethod==='top'){if(this.nearbyTiles(l+j,m+j,j)<=this.settings.emptyTolerance){if(this.seededRandom()<this.settings.reseedDensity){this.wTiles[l][m]=true}this.tiles[l][m]=this.wTiles[l][m]}}else{if(this.nearbyTiles(l,m,j)<=this.settings.emptyTolerance){if(this.seededRandom()<this.settings.reseedDensity){this.wTiles[l][m]=true}}}}else if(a==='remove-singles'){b=this.nearbyTiles(l,m,1);if(b===1&&this.tiles[l][m]){this.wTiles[l][m]=null}else if(b===8&&!this.tiles[l][m]){this.wTiles[l][m]=true}}}}for(l=f=1,h=this.w;1<=h?f<h:f>h;l=1<=h?++f:--f){for(m=e=1,k=this.h;1<=k?e<k:e>k;m=1<=k?++e:--e){this.tiles[l][m]=this.wTiles[l][m]}}return true},nearbyTiles:function(a,b,c){var d,f,e,j,i,g,h,k,l;d=0;for(k=f=j=a-c,i=a+c;j<=i?f<=i:f>=i;k=j<=i?++f:--f){for(l=e=g=b-c,h=b+c;g<=h?e<=h:e>=h;l=g<=h?++e:--e){if(k<0||k>=this.w||l<0||l>=this.h){d+=1}else{if(this.tiles[k][l]){d+=1}}}}return d},nearbyTile:function(a,b,c,d){return this.tiles[a+c][b+d]},findEdges:function(){var a,b,c,d,f,e,j,i,g;f=this.tiles;for(i=a=0,c=f.length;a<c;i=++a){e=f[i];for(g=b=0,d=e.length;b<d;g=++b){j=e[g];if(j){if(g>0){j.sides.above=this.tiles[i][g-1]}if(g<this.h){j.sides.below=this.tiles[i][g+1]}if(i>0){j.sides.left=this.tiles[i-1][g]}if(i<this.w){j.sides.right=this.tiles[i+1][g]}j.corners={tl:{x:(i+0)*this.tileSize,y:(g+0)*this.tileSize},tr:{x:(i+1)*this.tileSize,y:(g+0)*this.tileSize},bl:{x:(i+0)*this.tileSize,y:(g+1)*this.tileSize},br:{x:(i+1)*this.tileSize,y:(g+1)*this.tileSize}};j.surrounded=this.nearbyTiles(i,g,1)===9}}}return true},moveCorners:function(){var i,g,h,k,l,m,n,q,r,p,o;r=this.settings.wallRoughness*this.tileSize;q=[];for(p=i=0,n=this.w;0<=n?i<n:i>n;p=0<=n?++i:--i){q.push((function(){var a,b,c,d,f,e,j;j=[];for(o=a=0,b=this.h;0<=b?a<b:a>b;o=0<=b?++a:--a){l=m=0;if(this.settings.smoothCorners){g=0;if(this.tiles[p][o]){g+=1}if(this.tiles[p+1][o]){g+=2}if(this.tiles[p][o+1]){g+=4}if(this.tiles[p+1][o+1]){g+=8}if(g===1||g===4||g===11||g===14){l=-1}else if(g===2||g===7||g===8||g===13){l=1}if(g===1||g===2||g===14||g===14){m=-1}else if(g===4||g===7||g===8||g===11){m=1}l=l*this.tileSize/4;m=m*this.tileSize/4}h=((p+1)*this.tileSize)+l+this.randInt(-r/2,r);k=((o+1)*this.tileSize)+m+this.randInt(-r/2,r);if((c=this.tiles[p][o])!=null){c.corners.br={x:h,y:k}}if((d=this.tiles[p+1][o])!=null){d.corners.bl={x:h,y:k}}if((f=this.tiles[p][o+1])!=null){f.corners.tr={x:h,y:k}}j.push((e=this.tiles[p+1][o+1])!=null?e.corners.tl={x:h,y:k}:void 0)}return j}).call(this))}return q},findSides:function(){var d,f,e,j,i,g,h,k,l;j=this.tiles;i=[];for(k=d=0,f=j.length;d<f;k=++d){g=j[k];i.push((function(){var a,b,c;c=[];for(l=a=0,b=g.length;a<b;l=++a){h=g[l];if(h){h.lines=[];if(!h.sides.above){e={x1:h.corners.tl.x,y1:h.corners.tl.y,x2:h.corners.tr.x,y2:h.corners.tr.y};e.stuff=this.findNormals(e.x1,e.y1,e.x2,e.y2);h.lines.push(e)}if(!h.sides.left){e={x1:h.corners.tl.x,y1:h.corners.tl.y,x2:h.corners.bl.x,y2:h.corners.bl.y};e.stuff=this.findNormals(e.x2,e.y2,e.x1,e.y1);h.lines.push(e)}if(!h.sides.right){e={x1:h.corners.tr.x,y1:h.corners.tr.y,x2:h.corners.br.x,y2:h.corners.br.y};e.stuff=this.findNormals(e.x1,e.y1,e.x2,e.y2);h.lines.push(e)}if(!h.sides.below){e={x1:h.corners.bl.x,y1:h.corners.bl.y,x2:h.corners.br.x,y2:h.corners.br.y};e.stuff=this.findNormals(e.x2,e.y2,e.x1,e.y1);c.push(h.lines.push(e))}else{c.push(void 0)}}else{c.push(void 0)}}return c}).call(this))}return i},findNormals:function(a,b,c,d){var f,e;e=1;f=V.m2({x:a,y:b},{x:c,y:d});return{mp:e,ang:f.angle,normal:f.angle-Math.PI/2}},draw:function(){var a,b,c,d;d=this.settings.passes;for(a=0,b=d.length;a<b;a++){c=d[a];this.cellularPass(c)}this.generateCellular();this.findEdges();this.moveCorners();this.findSides();this.drawFloor();this.drawWalls(this.ctx);return this.imageData=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)},pixelAt:function(a,b){var c,d,f,e,j;a=Math.floor(a);b=Math.floor(b);e=((this.canvas.width*b)+a)*4;j=this.imageData.data[e];f=this.imageData.data[e+1];d=this.imageData.data[e+2];c=this.imageData.data[e+3];return[j,f,d,c]},drawWalls:function(d){var f,e,j,i,g,h,k,l;d.fillStyle='#585655';d.strokeStyle='#585655';j=this.tiles;i=[];for(k=f=0,e=j.length;f<e;k=++f){g=j[k];i.push((function(){var a,b,c;c=[];for(l=a=0,b=g.length;a<b;l=++a){h=g[l];if(h){d.beginPath();d.moveTo(h.corners.tl.x,h.corners.tl.y);d.lineTo(h.corners.tr.x,h.corners.tr.y);d.lineTo(h.corners.br.x,h.corners.br.y);d.lineTo(h.corners.bl.x,h.corners.bl.y);d.fill();c.push(d.stroke())}else{c.push(void 0)}}return c})())}return i},drawEdges:function(a){var b,c,d,f,e,j,i,g,h,k,l,m,n;a.strokeStyle='sandstone';a.beginPath();g=this.tiles;for(m=b=0,d=g.length;b<d;m=++b){k=g[m];for(n=c=0,f=k.length;c<f;n=++c){l=k[n];if(l){h=l.lines;for(i=0,e=h.length;i<e;i++){j=h[i];a.moveTo(j.x1,j.y1);a.lineTo(j.x2,j.y2)}}}}return a.stroke()},drawFloor:function(){var j,i,g,h,k,l,m,n,q,r,p,o,v,w,x,u,A,y,z,B,C,D,s,t;this.floorCtx.fillStyle='#888';this.floorCtx.fillRect(0,0,this.canvas.width,this.canvas.height);h=this.randInt(0,360);k=h+180;y=5;z=10;B=3;C=1;D=4;for(s=m=0,o=this.w;0<=o?m<=o:m>=o;s=0<=o?++m:--m){for(t=n=0,v=this.h;0<=v?n<=v:n>=v;t=0<=v?++n:--n){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,5))+"%,"+(this.randInt(60,20))+"%,0.5)";this.drawRandomisedRect(s*this.tileSize+this.randInt(0,y),t*this.tileSize+this.randInt(0,y),this.tileSize+this.randInt(0,z),this.tileSize+this.randInt(0,z),i,B)}}for(s=q=0,w=this.w;0<=w?q<=w:q>=w;s=0<=w?++q:--q){for(t=r=0,x=this.h;0<=x?r<=x:r>=x;t=0<=x?++r:--r){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,5))+"%,"+(this.randInt(60,20))+"%,0.8)";this.drawRandomisedRect(s*this.tileSize+this.randInt(0,y),t*this.tileSize+this.randInt(0,y),this.tileSize+this.randInt(0,z),this.tileSize+this.randInt(0,z),i,B)}}A=[];for(s=p=0,u=this.w;0<=u?p<=u:p>=u;s=0<=u?++p:--p){A.push((function(){var d,f,e;e=[];for(t=d=0,f=this.h;0<=f?d<=f:d>=f;t=0<=f?++d:--d){if(!(this.tiles[s][t]&&this.tiles[s][t].surrounded)){g=this.nearbyTiles(s,t,2);j=((1-(g/20))*80)/2+20;e.push((function(){var a,b,c;b=[];for(l=c=0,a=this.randInt(0,g*2);0<=a?c<=a:c>=a;l=0<=a?++c:--c){i="hsla("+(this.randHue(h,k))+","+(this.randInt(0,y))+"%,"+(this.randInt(j,20))+"%,0.8)";b.push(this.drawCircle(s*this.tileSize+this.randInt(0,this.tileSize),t*this.tileSize+this.randInt(0,this.tileSize),this.randInt(C,D),i))}return b}).call(this))}else{e.push(void 0)}}return e}).call(this))}return A},drawRandomisedRect:function(a,b,c,d,f,e){this.floorCtx.fillStyle=f;this.floorCtx.beginPath();this.floorCtx.moveTo(a+this.randInt(0,e),b+this.randInt(0,e));this.floorCtx.lineTo(a+c+this.randInt(0,e),b+this.randInt(0,e));this.floorCtx.lineTo(a+c+this.randInt(0,e),b+d+this.randInt(0,e));this.floorCtx.lineTo(a+this.randInt(0,e),b+d+this.randInt(0,e));return this.floorCtx.fill()},randHue:function(a,b){var c;if(Math.random()>0.5){c=a}else{c=b}return c+this.randInt(-10,20)},drawCircle:function(a,b,c,d){this.floorCtx.fillStyle=d;this.floorCtx.beginPath();this.floorCtx.arc(a,b,c,0,Math.PI*2);return this.floorCtx.fill()},lines:function(){var a,b,c,d,f,e,j,i,g,h,k,l;j=[];g=this.tiles;for(a=0,c=g.length;a<c;a++){k=g[a];for(b=0,d=k.length;b<d;b++){l=k[b];if(l){h=l.lines;for(i=0,f=h.length;i<f;i++){e=h[i];j.push([{x:e.x1,y:e.y1},{x:e.x2,y:e.y2},e.stuff])}}}}return j},seededRandom:function(){var a;a=Math.sin(this.seed++)*10000;return a-Math.floor(a)},randInt:function(a,b){return Math.floor(this.seededRandom()*b)+a}};window.Game={init:function(){Map.init();Map.draw();this.tileSize=Map.tileSize;this.state=0;this.orbCount=0;this.distQ=0;this.playerEl=byId('p');this.lightEl=byId('l');this.playerEl.style.left=((window.innerWidth-60)/2)+"px";this.playerEl.style.top=((window.innerHeight-48)/2)+"px";this.lightEl.style.left=((window.innerWidth-60)/2)+"px";this.lightEl.style.top=((window.innerHeight-48)/2)+"px";L.init(this.lightEl);this.initGameParams({monsters:[[32,49],[80,18],[102,19],[62,21],[76,38],[57,24],[113,72],[116,75],[117,72],[115,63],[73,67],[49,72],[5,70],[13,35],[49,75],[97,70],[86,12],[63,59],[91,22]],orbs:[[60,61],[35,33],[10,62],[18,48],[105,77],[114,50],[116,16],[49,29],[73,38],[80,5],[79,72],[101,58],[72,45],[80,49],[51,46]],triggers:[{x:116,y:34,r:"7",msg:"It's a maze of twisty|passages, all alike!"},{x:85,y:59,r:"7",msg:"I think we're headed|in the right direction"},{x:117,y:69,r:"5",msg:"I've got a bad feeling|about this ..."},{x:52,y:21,r:"7",msg:"I think we're almost there!"},{x:57,y:60,r:"5",msg:"Do we REALLY need|that light?"},{x:77,y:20,r:"7",msg:"I remember this path..."},{x:32,y:49,r:"15",msg:"A shadow moves in the|dark"},{x:81,y:49,r:"3",msg:"It's dangerous to go alone|I should take this"},{x:54,y:74,r:"7",msg:"Why are they|following me?"},{x:16,y:35,r:"3",msg:"Are those red dots ...|eyes?"},{x:4,y:51,r:"3",msg:"I feel like we're|going in circles!"},{x:35,y:32,r:"7",msg:"This cave is dark|and full of terrors"}]});this.maskCanvas=byId('lm');this.maskCtx=this.maskCanvas.getContext('2d');this.maskCanvas.width=Math.floor(window.innerWidth/2);this.maskCanvas.height=Math.floor(window.innerHeight/2);this.maskCanvas.style.width=window.innerWidth+'px';this.maskCanvas.style.height=window.innerHeight+'px';this.maskCtx.fillStyle='#000';this.maskCtx.fillRect(0,0,this.maskCanvas.width,this.maskCanvas.height);this.shadowCanvas=document.createElement('canvas');this.shadowCtx=this.shadowCanvas.getContext('2d');this.shadowCanvas.width=this.maskCanvas.width;this.shadowCanvas.height=this.maskCanvas.height;this.viewCanvas=byId('v');this.viewCtx=this.viewCanvas.getContext('2d');this.viewCanvas.width=this.maskCanvas.width;this.viewCanvas.height=this.maskCanvas.height;this.viewCanvas.style.width=this.maskCanvas.style.width;this.viewCanvas.style.height=this.maskCanvas.style.height;this.viewCtx.translate(0.5,0.5);this.itemsCanvas=document.createElement('canvas');this.itemsCtx=this.itemsCanvas.getContext('2d');this.itemsCanvas.width=this.maskCanvas.width;this.itemsCanvas.height=this.maskCanvas.height;this.positionMap();Msg.init(this.maskCtx,this.viewX,this.viewY);this.pos=this.tilePosToGameXY([76,49]);this.exit=this.tilePosToGameXY([37,21]);this.lines=[];this.speed=125;this.monsterSpeed=100;this.initLines();L.turnOff(3);this.openingText();return requestAnimationFrame(update)},update:function(a){var b,c,d,f,e;if(this.lastTimestamp){c=(a-this.lastTimestamp)/1000}else{c=0}this.lastTimestamp=a;this.timeStarted||(this.timeStarted=+new Date());if(this.state===1){f=byId('pg');f.style.top=parseInt(f.style.top)-1+'px'}else if(this.state===2){if(L.tweening){L.update(c)}}else{L.update(c);if(right||left||up||down){d=this.speed*c;e=12+d;if(right){if(!this.wallAt({x:this.pos.x+e,y:this.pos.y})){this.pos.x+=d}b='r'}if(left){if(!this.wallAt({x:this.pos.x-e,y:this.pos.y})){this.pos.x-=d}b='l'}if(down){if(!this.wallAt({x:this.pos.x,y:this.pos.y+e})){this.pos.y+=d}b='d'}if(up){if(!this.wallAt({x:this.pos.x,y:this.pos.y-e})){this.pos.y-=d}b='u'}this.lightEl.className=this.playerEl.className=b;if(this.itemInRange({x:this.exit.x,y:this.exit.y-70},80)){this.win()}}if(window.toggleL){if(L.on){L.turnOff()}else{L.turnOn()}window.toggleLight=false}this.playerTouchingOrb();this.playerTouchingTrigger();this.moveMonsters(c);Msg.update(c)}return this.draw(c)},moveMonsters:function(b){var c,d,f,e,j,i,g,h,k,l,m,n,q,r,p,o,v,w,x,u;r=this.monsters;p=[];for(h=k=0,m=r.length;k<m;h=++k){n=r[h];if(this.itemOnScreen(n)||n.state===1){i=(this.pos.x-n.x)/20;g=(this.pos.y-n.y)/20;u=true;for(h=l=0;l<=20;h=++l){if(this.wallAt({x:n.x+i*h,y:n.y+g*h})){u=false}}if(u&&n.state===0){p.push(n.state=1)}else if(n.state===1){c=V.m2(n,this.pos);j=c.distance;d=c.angle;if(u&&L.on&&j<(L.viewRadius+20)){o=j-L.viewRadius;d+=0.5}else{o=this.monsterSpeed}v=true;f=0;if(o<0){e=true;d+=Math.PI;o=-o}p.push((function(){var a;a=[];while(v&&f<20){q=V.m1(n,d,o*b);w=V.m1(q,d+1.0,18.0);x=V.m1(q,d-1.0,18.0);f+=1;if(e&&(this.wallAt(w)||this.wallAt(x))){a.push(f=999)}else if(this.wallAt(w)){d-=0.3;a.push(o=o+15)}else if(this.wallAt(x)){d+=0.4;a.push(o=o+10)}else{n.x=q.x;n.y=q.y;v=false;if(this.state===0){if(V.m3(this.pos,n)<22){a.push(this.die())}else{a.push(void 0)}}else{a.push(void 0)}}}return a}).call(this))}else{p.push(void 0)}}else{p.push(void 0)}}return p},die:function(){var a;byId('vp').className='ded';a=byId('pg');a.style.top=this.playerEl.style.top;a.style.left=this.playerEl.style.left;this.state=1;Msg.say('You had one job ... ',{x:-130,y:this.viewY-40,colour:'#b00',size:30});if(L.alpha<0.4){L.alpha=0.4}if(L.viewRadius<20){L.viewRadius=20}return this.printStats()},win:function(){byId('vp').className='win';this.state=2;this.playerEl.className='d';this.lightEl.className='d';L.addPower();Msg.say("Thanks, you're a hero!",{x:-170,y:this.viewY-70,colour:'#0c0',size:30,hold:10});Msg.say("I think Ill be ok from here :)",{x:-170,y:this.viewY-30,colour:'#0a0',size:25,hold:10});return this.printStats()},printStats:function(){var a,b;b=Math.floor((+new Date()-this.timeStarted)/1000);a="You lasted "+b+" seconds and collected "+this.orbCount+" of "+this.orbs.length+" light orbs";return Msg.say(a,{x:-this.viewX+10,y:-this.viewY+20,hold:100,size:12})},draw:function(){this.shadowCtx.clearRect(0,0,this.shadowCanvas.width,this.shadowCanvas.height);this.shadowCtx.save();this.shadowCtx.translate(this.viewX-this.pos.x,this.viewY-this.pos.y);this.itemsCtx.clearRect(0,0,this.itemsCanvas.width,this.itemsCanvas.height);this.itemsCtx.save();this.itemsCtx.translate(this.viewX-this.pos.x,this.viewY-this.pos.y);this.maskCtx.fillStyle='#000';this.maskCtx.fillRect(0,0,this.maskCanvas.width,this.maskCanvas.height);this.drawOrbs();this.drawMonsters();this.drawLineShadows();this.drawPlayerShadow();this.drawExit(this.itemsCtx);this.itemsCtx.restore();this.shadowCtx.restore();this.compositeCanvas();return Msg.draw()},wallAt:function(a){return Map.pixelAt(a.x,a.y)[3]>10},compositeCanvas:function(){this.viewCtx.fillStyle='#585655';this.viewCtx.fillRect(0,0,this.viewCanvas.width,this.viewCanvas.height);this.viewCtx.drawImage(Map.floorCanvas,this.viewX-this.pos.x,this.viewY-this.pos.y);this.itemsCtx.globalCompositeOperation='destination-out';this.itemsCtx.drawImage(this.shadowCanvas,0,0);this.itemsCtx.globalCompositeOperation='source-over';this.maskCtx.drawImage(this.shadowCanvas,0,0);this.viewCtx.drawImage(this.itemsCanvas,0,0);if(L.on){this.viewCtx.globalAlpha=0.7;this.viewCtx.drawImage(this.shadowCanvas,0,0);this.viewCtx.globalAlpha=1}this.viewCtx.drawImage(Map.canvas,this.viewX-this.pos.x,this.viewY-this.pos.y);return this.drawLightMask()},drawPlayerShadow:function(){var a,b;b=24/2;this.shadowCtx.save();this.shadowCtx.translate(this.pos.x,this.pos.y+24/2);this.shadowCtx.scale(1,0.25);a=this.shadowCtx.createRadialGradient(0,0,0,0,0,b);a.addColorStop(0,'rgba(0,0,0,0.6)');a.addColorStop(1,'rgba(0,0,0,0)');this.shadowCtx.fillStyle=a;this.shadowCtx.beginPath();this.shadowCtx.arc(0,0,b,0,Math.PI*2);this.shadowCtx.fill();return this.shadowCtx.restore()},playerTouchingOrb:function(){var a,b,c,d,f,e;f=this.orbs;e=[];for(a=b=0,c=f.length;b<c;a=++b){d=f[a];if(this.itemInRange(d,this.tileSize)&&!d.used){L.addPower();this.orbCount+=1;e.push(d.used=true)}else{e.push(void 0)}}return e},playerTouchingTrigger:function(){var a,b,c,d,f;c=this.triggers;d=[];for(a=0,b=c.length;a<b;a++){f=c[a];if(this.itemInRange(f,f.r)&&!f.used){if(f.msg){Msg.say(f.msg)}d.push(f.used=true)}else{d.push(void 0)}}return d},drawOrbs:function(){var a,b,c,d,f,e,j,i,g,h,k;a=this.itemsCtx;c=15;h=4;b=a.createRadialGradient(0,0,h,0,0,c);b.addColorStop(0,'rgba(143,194,242,0.4)');b.addColorStop(1,'rgba(191,226,226,0)');g=a.createRadialGradient(1,-1,1,0,0,h);g.addColorStop(0,'#bfe2e2');g.addColorStop(1,'#8fc2f2');this.maskCtx.fillStyle="#000";j=c*1.5;d=this.maskCtx.createRadialGradient(0,0,0,0,0,j);d.addColorStop(0,"rgba(255,255,255,0.8)");d.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=d;k=this.orbs;for(f=0,e=k.length;f<e;f++){i=k[f];if(this.itemOnScreen(i)&&!i.used){a.save();a.translate(i.x,i.y);a.fillStyle=b;a.beginPath();a.arc(0,0,c,0,Math.PI*2);a.fill();a.fillStyle=g;a.beginPath();a.arc(0,0,h,0,Math.PI*2);a.fill();a.restore();this.maskCtx.save();this.maskCtx.translate(i.x-this.pos.x+this.viewX,i.y-this.pos.y+this.viewY);this.maskCtx.beginPath();this.maskCtx.arc(0,0,j,0,Math.PI*2);this.maskCtx.fill();this.maskCtx.restore()}}return this.maskCtx.globalCompositeOperation='source-over'},drawMonsters:function(){var a,b,c,d,f,e,j,i,g;b=this.itemsCtx;c=this.maskCtx;j=12;i=this.monsters;g=[];for(d=0,f=i.length;d<f;d++){e=i[d];if(this.itemOnScreen(e)){a=V.m2(this.pos,e);b.save();b.translate(e.x,e.y);b.rotate(a.angle);b.fillStyle='#000';b.beginPath();b.arc(0,0,j,0,Math.PI*2);b.fill();b.fillStyle='#a10';b.scale(0.5,1.0);b.beginPath();b.arc(-13,4,3,0,Math.PI*2);b.arc(-13,-4,3,0,Math.PI*2);b.fill();b.restore();c.save();c.translate(e.x-this.pos.x+this.viewX,e.y-this.pos.y+this.viewY);c.rotate(a.angle);c.fillStyle='#f20';c.scale(0.5,1.0);c.beginPath();c.arc(-13,4,3,0,Math.PI*2);c.arc(-13,-4,3,0,Math.PI*2);c.fill();g.push(c.restore())}else{g.push(void 0)}}return g},itemInRange:function(a,b){return(Math.abs(a.x-this.pos.x)<b)&&(Math.abs(a.y-this.pos.y)<b)},itemOnScreen:function(a){return(Math.abs(a.x-this.pos.x)<this.viewX)&&(Math.abs(a.y-this.pos.y)<this.viewY)},drawLines:function(){var a,b,c,d;this.shadowCtx.strokeStyle='#800';this.shadowCtx.beginPath();d=this.lines;for(a=0,c=d.length;a<c;a++){b=d[a];this.shadowCtx.moveTo(b[0].x,b[0].y);this.shadowCtx.lineTo(b[1].x,b[1].y)}return this.shadowCtx.stroke()},drawLineShadows:function(){var a,b,c,d,f,e,j,i,g,h,k;this.shadowCtx.fillStyle='#000';this.shadowCtx.strokeStyle='#000';h=this.lines;k=[];for(f=0,j=h.length;f<j;f++){e=h[f];i=e[0];if(this.itemOnScreen(i)){g=e[1];a=V.m2(this.pos,i);b=V.m2(this.pos,g);if(e[2]){c=a.angle;d=c-e[2].ang;if(d<Math.PI){d+=Math.PI*2}if(d>Math.PI){d-=Math.PI*2}if(d<0){k.push(this.drawShadow(i,g,a.angle,b.angle))}else{k.push(void 0)}}else{k.push(void 0)}}else{k.push(void 0)}}return k},drawShadow:function(a,b,c,d){var f,e;this.shadowCtx.beginPath();f=V.m1(a,c,900);e=V.m1(b,d,900);this.shadowCtx.moveTo(a.x,a.y);this.shadowCtx.lineTo(f.x,f.y);this.shadowCtx.lineTo(e.x,e.y);this.shadowCtx.lineTo(b.x,b.y);this.shadowCtx.lineTo(a.x,a.y);this.shadowCtx.fill();this.shadowCtx.beginPath();this.shadowCtx.moveTo(a.x,a.y);this.shadowCtx.lineTo(f.x,f.y);return this.shadowCtx.stroke()},drawLightMask:function(){var a,b;this.maskCtx.fillStyle="#000";b=L.viewRadius;a=this.maskCtx.createRadialGradient(this.viewX,this.viewY,b/4,this.viewX,this.viewY,b);a.addColorStop(0,"rgba(255,255,255,"+L.alpha+")");a.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=a;this.maskCtx.beginPath();this.maskCtx.arc(this.viewX,this.viewY,b,0,Math.PI*2);this.maskCtx.fill();return this.maskCtx.globalCompositeOperation='source-over'},drawExit:function(a){var b,c,d,f,e,j,i,g,h,k;if(this.itemOnScreen(this.exit)){i=this.tileSize;if(!this.lightRays){this.lightRays=[];for(c=d=0;d<=5;c=++d){k=randInt(-i,i*2);this.lightRays.push({x:k,y:randInt(-7,14),w:randInt(2,i-k),h:randInt(100,50)})}}a.save();a.translate(this.exit.x,this.exit.y);a.scale(1,0.4);b=a.createRadialGradient(0,0,0,0,0,i);b.addColorStop(0,'rgba(255, 255, 255, 0.9)');b.addColorStop(1,'rgba(255, 255, 255, 0.2)');a.fillStyle=b;a.beginPath();a.arc(0,0,i,0,Math.PI*2);a.fill();a.restore();a.save();a.translate(this.exit.x,this.exit.y);h=this.lightRays;for(f=0,e=h.length;f<e;f++){g=h[f];b=a.createLinearGradient(g.x,g.y,g.x,g.y-g.h);b.addColorStop(0,"rgba(255, 255, 255, "+(0.3+Math.random()/5)+")");b.addColorStop(1,'rgba(255, 255, 255, 0)');a.fillStyle=b;a.beginPath();a.moveTo(g.x,g.y);a.lineTo(g.x-0.2*g.h,g.y-g.h);a.lineTo(g.x-0.2*g.h+g.w,g.y-g.h);a.lineTo(g.x+g.w,g.y);a.fill()}a.restore();this.maskCtx.fillStyle="#000";j=i*1.5;b=this.maskCtx.createRadialGradient(0,0,0,0,0,j);b.addColorStop(0,"rgba(255,255,255,0.8)");b.addColorStop(1,'rgba(255,255,255,0)');this.maskCtx.globalCompositeOperation='destination-out';this.maskCtx.fillStyle=b;this.maskCtx.save();this.maskCtx.translate(this.exit.x-this.pos.x+this.viewX,this.exit.y-this.pos.y+this.viewY);this.maskCtx.scale(1,0.4);this.maskCtx.beginPath();this.maskCtx.arc(0,0,j,0,Math.PI*2);this.maskCtx.fill();this.maskCtx.restore();return this.maskCtx.globalCompositeOperation='source-over'}},initLines:function(){return this.lines=Map.lines()},positionMap:function(){this.viewX=window.innerWidth/4;return this.viewY=window.innerHeight/4},initGameParams:function(a){var b,c,d,f,e,j,i,g,h,k,l,m,n;this.monsters=[];this.orbs=[];this.triggers=[];h=a.monsters;for(b=0,d=h.length;b<d;b++){g=h[b];j=this.tilePosToGameXY(g);j.state=0;this.monsters.push(j)}k=a.orbs;for(c=0,f=k.length;c<f;c++){g=k[c];this.orbs.push(this.tilePosToGameXY(g))}l=a.triggers;m=[];for(i=0,e=l.length;i<e;i++){n=l[i];n.x*=this.tileSize;n.y*=this.tileSize;n.r=n.r*this.tileSize/2;m.push(this.triggers.push(n))}return m},tilePosToGameXY:function(a){return{x:(a[0]+.5)*this.tileSize,y:(a[1]+.5)*this.tileSize}},openingText:function(){Msg.say('...');return setTimeout((function(){return Msg.say("How did I end up here?")}),2000)}};window.randSeed=1234;window.randomX=function(){var a;a=Math.sin(randSeed++)*10000;return a-Math.floor(a)};window.randInt=function(a,b){return Math.floor(randomX()*b)+a};window.update=function(a){Game.update(a);window.requestAnimationFrame(update);return true};window.byId=function(a){return document.getElementById(a)};window.up=window.right=window.down=window.left=false;window.onkeydown=function(a){if(a.keyCode===32){window.toggleLight=true}if(a.keyCode===38||a.keyCode===90||a.keyCode===87){window.up=true}if(a.keyCode===39||a.keyCode===68){window.right=true}if(a.keyCode===40||a.keyCode===83){window.down=true}if(a.keyCode===37||a.keyCode===65||a.keyCode===81){return window.left=true}};window.onkeyup=function(a){if(a.keyCode===38||a.keyCode===90||a.keyCode===87){window.up=false}if(a.keyCode===39||a.keyCode===68){window.right=false}if(a.keyCode===40||a.keyCode===83){window.down=false}if(a.keyCode===37||a.keyCode===65||a.keyCode===81){return window.left=false}};window.initGame=function(){return Game.init()}}).call(this);
